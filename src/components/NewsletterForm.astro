---
interface Props {
  variant?: 'default' | 'card';
  centered?: boolean;
  showDescription?: boolean;
}

const { variant = 'default', centered = false, showDescription = true } = Astro.props;
const formId = '3725037';

const isCard = variant === 'card';
---

{isCard ? (
  <!-- Card variant (homepage style) -->
  <div class="bg-white rounded-2xl p-6 max-w-lg shadow-sm">
    <form
      action={`https://app.kit.com/forms/${formId}/subscriptions`}
      method="post"
      data-sv-form={formId}
      data-uid={formId}
      data-format="inline"
      data-version="5"
      class="newsletter-form flex flex-col gap-4"
    >
      <input
        type="email"
        name="email_address"
        placeholder="Your best email"
        required
        aria-label="Email address"
        class="w-full px-5 py-4 rounded-xl bg-[#f5f5f5] text-brand-brown placeholder:text-brand-brown/50 focus:outline-none focus:ring-2 focus:ring-brand-brown/20 font-body text-lg"
      />
      <button
        type="submit"
        class="w-full px-5 py-4 rounded-xl bg-brand-brown text-white font-heading font-semibold text-lg hover:opacity-90 transition-opacity"
      >
        Upgrade Your Design Eye
      </button>
    </form>
  </div>
) : (
  <!-- Default inline variant -->
  <form
    action={`https://app.kit.com/forms/${formId}/subscriptions`}
    method="post"
    data-sv-form={formId}
    data-uid={formId}
    data-format="inline"
    data-version="5"
    class:list={[
      "newsletter-form flex flex-col sm:flex-row gap-3",
      centered ? "max-w-md mx-auto" : "max-w-md"
    ]}
  >
    <input
      type="email"
      name="email_address"
      placeholder="your@email.com"
      required
      aria-label="Email address"
      class:list={[
        "flex-1 px-4 py-3 rounded-full bg-brand-cream border-2 border-transparent",
        "focus:border-brand-brown focus:outline-none font-body",
        centered ? "text-center sm:text-left" : ""
      ]}
    />
    <button
      type="submit"
      class="btn btn-primary whitespace-nowrap"
    >
      Subscribe
    </button>
  </form>
)}

{showDescription && !isCard && (
  <p class:list={[
    "mt-3 text-sm text-brand-brown/60",
    centered ? "text-center" : ""
  ]}>
    Sent 2-3x every week. No spam. Unsubscribe anytime.
  </p>
)}

<style>
  .newsletter-form button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<script>
  document.querySelectorAll('.newsletter-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formEl = e.target as HTMLFormElement;
      const button = formEl.querySelector('button');
      const emailInput = formEl.querySelector('input[type="email"]') as HTMLInputElement;

      if (!button || !emailInput) return;

      const originalText = button.textContent;
      button.textContent = 'Subscribing...';
      button.setAttribute('disabled', 'true');

      try {
        const formData = new FormData(formEl);
        const response = await fetch(formEl.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json',
          },
        });

        if (response.ok) {
          button.textContent = 'Subscribed!';
          emailInput.value = '';
          setTimeout(() => {
            button.textContent = originalText;
            button.removeAttribute('disabled');
          }, 3000);
        } else {
          throw new Error('Subscription failed');
        }
      } catch (error) {
        button.textContent = 'Try again';
        button.removeAttribute('disabled');
        setTimeout(() => {
          button.textContent = originalText;
        }, 3000);
      }
    });
  });
</script>
